\section{Rekonstruktion toteutus}
Eräs keino säteen lävistämien kuva-alueen vokseleiden laskentaan on Siddonin kehittämä kuva-alueen vokseleiden säännöllisyyttä hyödyntävä algoritmi\cite{siddon_fast_1985, sundermann_fast_1998}. Siddonin algoritmiin tarvitaan kaksi pistettä säteen virittämältä suoralta avaruudessa kuva-alueen parametrien lisäksi\cite{sundermann_fast_1998}. Koska epäideaalin kollimaattorin reikä kerää säteilyä kartion muotoiselta alueelta avaruudessa\cite{cherry_single_2012}, jokaiselle detektorin pikselille asetetaan useampi säde kollimaattorin reikien sisälle. Kunkin säteen lävistämät vokselit ja pituudet niissä määritetään, jonka jälkeen pituudet keskiarvoistetaan vokselikohtaisesti. Projektion laskentaan käytetään näitä keskiarvoja.

Työssä toteutettiin kolme eri mallia kollimaattorille. Kaksi mallia on suunniteltu kollimaattorille, jonka reiät ovat suoria särmiöitä kuusikulmaisella pohjalla. Ensimmäinen malli on kehitetty mahdollisimman todenmukaista rekonstruktiota varten ja toinen laskentatehokkuutta ajatellen. Kolmas malli on kaikista yleisin ja se soveltuu erityisesti kollimaattoreille, jossa jokaisen detektorin pikselin päällä on ainoastaan yksi neliön muotoinen kollimaattorin reikä.

Kollimaattorin mallintava koodi kehitettiin MATLAB-ympäristössä (R2023b, Mathworks Inc.) testauksen nopeuden ja helppouden vuoksi. Toimivassa versiossa hyödynnettiin eräitä MATLABin funktioita, joita ei ole C++:n vakiokirjastossa. Näitä ovat muun muuassa trigonometriset funktiot, joiden argumenttina on kulma asteina sekä funktio \texttt{floorDiv}, joka laskee ensin kahden luvun osamäärän ja pyöristää sen alaspäin lähimpään kokonaislukuun. Koodin luettavuuden kannalta on helpompaa toteuttaa nämä erillisinä apufunktioina C++:ssa. Apufunktiot kokonaisuudessaan ovat esitetty \hyperref[appendix:apufunktiot]{liitteessä \ref*{appendix:apufunktiot}}.

Parametreinä jokaisessa mallissa ovat detektorin pikselin koko, pikselin indeksi detektoripaneelissa, kollimaattorin reiän halkaisija, reiän pituus, reikien välinen etäisyys (\textit{septal width}), kuusikulmaisen reiän suuntaus ja säteiden lukumäärä. Reiän suuntauksessa arvo 1 asettaa kuusikulmion kärjet detektoripaneelin tason $x$-akselin suuntaisesti ja arvo 2 $y$-akselin suuntaisesti. Pääfunktioiden \texttt{computeSpectHexShifts} ja \texttt{computeSpectSquareShifts} parametrit ovat esitetty myös \hyperref[appendix:parametrit]{liitteen \ref*{appendix:parametrit}} taulukossa.

\subsection{Kuusikulmainen kollimaattorin reikä}
Kahdessa ensimmäisessä mallissa kollimaattorin yksittäisen reiän ajatellaan koostuvan sisäkkäisistä kuusikulmaisista suorista särmiöistä. Jokaiselle särmiölle muodostetaan kuusi avaruuslävistäjää, jotka toimivat projektion laskennassa tarvittavina säteinä. Ennen laskentaa kuitenkin tarkistetaan vielä, että säteet osuvat oikeaan pikseliin detektorissa. Kuvat \ref{fig:ray1} ja \ref{fig:ray2} havainnollistavat säteiden jakautumista detektoripaneelin tasossa ja kuva-alueessa. Tasolle on rajattu detektorin pikselit punaisella viivalla ja säteiden päätepisteet sinisillä pisteillä. Oikealla puolella on kuva-alueen $xy$-koordinaatisto eli transversaalitaso.

\begin{figure}[H]
    \centering
    \captionsetup{width=.9\textwidth}
    \includegraphics[height=6cm]{kuvat/malli1.pdf}
    \caption{Kollimaattorin mallin 1 havainnollistus detektorin tasossa (vasemmalla) ja kuva-alueen transversaalitasossa (oikealla). Detektoripaneelin pikselit ovat rajattu punaisilla viivoilla. Kuva-alue on piirretty mustalla ruudukolla ja detektorin havaitsemat säteet (108 kappaletta) sinisellä värillä. Kollimaattorin reiän pituus on \qty{32.4}{\milli\meter}, reiän halkaisija on \qty{1.4}{\milli\meter} ja reikien välinen etäisyys on \qty{0.12}{\milli\meter}. Detektorin pikselin koko on \qty{4.664}{\milli\meter}. Yksi kuva-alueen ruudukon neliö vastaa $8^2$ vokselia, jossa yksittäisen vokselin koko on $(\qty{4.664}{\milli\meter})^{3}$.}
    \label{fig:ray1}
\end{figure}

\begin{figure}[H]
    \centering
    \captionsetup{width=.9\textwidth}
    \includegraphics[height=6cm]{kuvat/malli2.pdf}
    \caption{Kollimaattorin mallin 2 havainnollistus detektorin tasossa (vasemmalla) ja kuva-alueen transversaalitasossa (oikealla). Detektoripaneelin pikselit ovat rajattu punaisilla viivoilla. Kuva-alue on piirretty mustalla ruudukolla ja detektorin havaitsemat säteet (61 kappaletta) sinisellä värillä. Kollimaattorin reiän pituus on \qty{32.4}{\milli\meter}, reiän halkaisija on \qty{1.4}{\milli\meter} ja reikien välinen etäisyys on \qty{0.12}{\milli\meter}. Detektorin pikselin koko on \qty{4.664}{\milli\meter}. Yksi kuva-alueen ruudukon neliö vastaa $8^2$ vokselia, jossa yksittäisen vokselin koko on $(\qty{4.664}{\milli\meter})^{3}$.}
    \label{fig:ray2}
\end{figure}

Ensimmäisessä mallissa kollimaattorin reiät ovat todenmukaisissa paikoissaan. \hyperref[fig:ray1]{Kuvan \ref*{fig:ray1}} malli sisältää 108 sädettä, kun yhdessä kollimaattorin reiässä on 7 sädettä. \hyperref[fig:ray1]{Kuvan \ref*{fig:ray2}} malli muodostuu vain yhdestä kollimaattorin reiästä detektorin pikseliä kohti ja kuvaan on piirretty 61 sädettä. Kuvista nähdään, kuinka detektorin havaitsema alue avaruudesta täyttyy tasaisemmin yhden reiän mallilla, vaikka säteitä on yli kolmannes vähemmän.

Koska malleille 1 ja 2 on yhteistä se, kuinka säteet asettuvat kollimaattorin yksittäiseen reikään, oli luontevaa eriyttää säteiden päätepisteiden asettava funktio omakseen. \hyperref[appendix:2Dsiirto]{Liitteen \ref*{appendix:2Dsiirto}} funktio \texttt{computeHexShifts2D} asettaa säännöllisen kuusikulmion sisälle $n\in\NN$ pistettä.

Funktiolle \texttt{computeHexShifts2D} annetaan parametreinä pisteiden lukumäärä \texttt{nPoints}, kuusikulmion kärjen ja $x$-akselin välinen kulma \texttt{startAngle} ja kuusikulmion halkaisija \texttt{diameter}. Funktio palauttaa listan pisteistä $(x, y)\in\RR^2$, jotka vastaavat kuusikulmioon sijoittuvien pisteiden koordinaatteja. Tämä lista, C++:n vakiokirjaston vektori \texttt{hexShifts}, alustetaan rivillä 3. Riveillä 4-6 tarkistetaan, onko kuusikulmioon asetettavien pisteiden lukumäärä 1. Jos näin on, niin ainut palautettava piste on kuusikulmion keskipiste $(0, 0)$. Rivillä 8 asetettu muuttuja \texttt{currentPoint} pitää kirjaa siitä, kuinka monta pistettä vektoriin \texttt{hexShifts} on jo lisätty. Seuraavalla rivillä asetetaan kuusikulmion säteelle apumuuttuja \texttt{radius}, jotta sädettä ei tarvitse laskea kuin kerran.

Kun kuusikulmio jaetaan tasasivuisiin kolmioihin, kolmioiden kärkipisteistä saadaan tasaisesti jakautuneita pisteitä kuusikulmion sisällä. Kolmioiden määrityksessä kuusikulmio on jaettu useampaan kerrokseen, joista jokaista rajaa kaksi sisäkkäistä kuusikulmiota. Periaate on esitetty \hyperref[fig:6kulmio]{Kuvassa \ref*{fig:6kulmio}} eri kerrosten lukumäärällä. Kuvan vasemmassa laidassa kerroksia on nolla, eli ainoa piste on kuusikulmion keskipiste. Oikealle päin seuraavassa kuvassa kerroksia on yksi eli pisteet ovat kuusikulmion keskipiste ja kaikki kulmat. Seuraavassa kuvassa kerroksia on kaksi, josta nähdään, kuinka voidaan muodostaa 24 tasasivuista kolmiota. Kärkipisteitä näillä kolmioilla on yhteensä 19. Oikeanpuolimmaisessa kuvassa kerroksia on kolme, jolloin kuusikulmio jakautuu 54 tasasivuiseen kolmioon ja 37 kärkipisteeseen.
\begin{figure}[H]
    \centering
    \captionsetup{width=.9\textwidth}
    \begin{subfigure}[t]{.225\textwidth}
        \includegraphics[width=.9\linewidth]{kuvat/6kulmio0.pdf}
        \caption{}
    \end{subfigure}%
    \begin{subfigure}[t]{.225\textwidth}
        \includegraphics[width=.9\linewidth]{kuvat/6kulmio1.pdf}
        \caption{}
    \end{subfigure}%
    \begin{subfigure}[t]{.225\textwidth}
        \includegraphics[width=.9\linewidth]{kuvat/6kulmio2.pdf}
        \caption{}
    \end{subfigure}%
    \begin{subfigure}[t]{.225\textwidth}
        \includegraphics[width=.9\linewidth]{kuvat/6kulmio3.pdf}
        \caption{}
    \end{subfigure}%
    \caption{Kuusikulmion jakaminen kerroksiin. Harmaa katkoviiva kuvaa kuusikulmion kehää. Siniset pisteet ovat kuusikulmion jakavien tasasivuisten kolmioiden kärkipisteitä. Kuvassa (a) kerroksia on nolla, eli pisteitä on yksi. Kuvassa (b) on yksi kerros ja yhteensä 7 pistettä. Kuvassa (c) on kolme ja kuvassa (d) neljä kerrosta sekä vastaavasti 19 ja 37 pistettä.}
    \label{fig:6kulmio}
\end{figure}

Havaitaan, että kerrosten lukumäärän $k$ lisääntyessä yhdellä, olettaen $k>0$, pisteiden lukumäärä lisääntyy $6k$:lla. Siis, jos kerroksia on $k$ kappaletta, niin pisteitä on
\begin{equation}\label{eqn:pisteidenlkm}
    n=1+\sum\limits_{i=0}^{k}6i
\end{equation}
kappaletta. Koska funktiolle \texttt{computeHexShifts2D} syötetään pisteiden lukumäärä, tasaista asettelua varten täytyy määrittää pienin kerrosten lukumäärä $k$, jolle kaikki pisteet mahtuvat. Käytännössä yhtälöstä (\ref{eqn:pisteidenlkm}) täytyy ratkaista muuttuja $k$, joka tapahtuu aritmeettisen summan osasumman\cite{harjulehto_analyysia_2022} avulla. Osasummasta saadaan
\begin{equation*}
    n-1=6\frac{k(k+1)}{2},
\end{equation*}
joka on muuttujan $k$ toisen asteen yhtälö. Yhtälön juuret ovat
\begin{equation*}
    k=\frac{1}{2}\left( \pm\sqrt{4\cdot\frac{n - 1}{3} + 1} - 1 \right)
\end{equation*}
ja koska kerrosten lukumäärän täytyy olla epänegatiivinen, saadaan
\begin{equation*}
    k=\frac{1}{2}\left( \sqrt{4\cdot\frac{n - 1}{3} + 1} - 1 \right).
\end{equation*}
Kerrosten lukumäärän täytyy olla myös kokonaisluku, joten pyöristetään kerrosten lukumäärä ylöspäin lähimpään kokonaislukuun. Siten
\begin{equation}\label{eqn:kerrostenlkm}
    k=\left\lceil\frac{1}{2}\left( \sqrt{4\cdot\frac{n - 1}{3} + 1} - 1 \right)\right\rceil.
\end{equation}
Yhtälö (\ref{eqn:kerrostenlkm}) on toteutettu funktion \texttt{computeHexShifts2D} rivillä 10.

Riveillä 12 ja 13 asetetaan tilapäiset muuttujat kuusikulmion pisteen sijainnille. Riviltä 15 eteenpäin käydään läpi jokainen kuusikulmion kerros, jokaisen kerroksen kärki ja asetetaan tilapäisten muuttujien arvoiksi kärjen sijainti. Kerroksella $k$, $k>0$, tilapäistä muuttujaa siirretään $6k$ kertaa tasaisin välein ja pisteet tallennetaan vektoriin \texttt{hexShifts}. Joka lisäyksellä tarkistetaan, onko vektori \texttt{hexShifts} täynnä. Jos on, niin vektori palautetaan.

Funktion \texttt{computeSpectHexShifts} riveillä 3--9 parametrit asetetaan muuttujiin, joita käytettiin funktion kehitysvaiheessa MATLABissa. Riveillä 12--15 määritetään detektoripaneelin ulkonormaalivektori. Paneelin kulma positiiviseen $x$-akseliin nähden on laskettu rivillä 18. Riveillä 21--28 lasketaan detektorin pikselin keskipiste ja reunat detektoripaneelin $xy$-tasossa. Näitä tietoja tarvitaan siirtäessä lasketut säteet detektoripaneelin tasosta kolmiulotteiseen avaruuteen. Rivit 31--56 määrittävät kuusikulmioiden väliset etäisyydet $x$- ja $y$-suunnissa sekä säteiden päätepisteiden siirrot yhdessä kollimaattorin reiässä. Kollimaattorin reikien keskipisteet ovat laskettu riveillä 59--91 tarkalle mallille 1 ja riveillä 92--96 tehokkaalle mallille 2. Viimeinen vaihe on säteen päätepisteiden siirtojen lisääminen jokaisen kollimaattorin reiän keskipisteeseen ja koordinaatistomuunnos paneelin tasosta kolmiulotteiseen avaruuteen. Siirtojen lisääminen tapahtuu riveillä 104--107 ja koordinaatistomuunnos riveillä 114--119. Pisteet tallennetaan palautettavaan vektoriin \texttt{hexShifts}, jonka lopusta poistetaan ylimääräiset alkiot rivillä 130.

\subsection{Nelikulmainen kollimaattorin reikä}
\hyperref[fig:ray3]{Kuvassa \ref*{fig:ray3}} on esitetty kolmas malli, jossa säteiden päätepisteet jakautuvat tasaisesti detektorin pikselin sisälle.

\begin{figure}[H]
    \centering
    \captionsetup{width=.9\textwidth}
    \includegraphics[height=6cm]{kuvat/malli3.pdf}
    \caption{Kollimaattorin mallin 3 havainnollistus detektorin tasossa (vasemmalla) ja kuva-alueen transversaalitasossa (oikealla). Detektoripaneelin pikselit ovat rajattu punaisilla viivoilla. Kuva-alue on piirretty mustalla ruudukolla ja detektorin havaitsemat säteet (64 kappaletta) sinisellä värillä. Kollimaattorin reiän pituus on \qty{32.4}{\milli\meter}, reiän halkaisija on \qty{1.4}{\milli\meter} ja reikien välinen etäisyys on \qty{0.12}{\milli\meter}. Detektorin pikselin koko on \qty{4.664}{\milli\meter}. Yksi kuva-alueen ruudukon neliö vastaa $8^2$ vokselia, jossa yksittäisen vokselin koko on $(\qty{4.664}{\milli\meter})^{3}$.}
    \label{fig:ray3}
\end{figure}

Malli on toteutettu yhdellä funktiolla \texttt{computeSpectSquareShifts}, joka on esitetty \hyperref[appendix:malli3]{liitteessä \ref*{appendix:malli3}}. Funktion rivit 1--15 ovat kuten kuusikulmaisen kollimaattorin mallissa, mutta riveillä 17--24 asetetaan pikselin koko näennäisesti suuremmaksi lähempänä kuva-aluetta. Samalla huomioidaan se, kuinka paljon säteet leviävät kuva-alueessa kollimaattorin epäideaalisuuden vuoksi. Tässä mallissa kerrosten määrä käsitellään rivillä 26 hieman eri tavalla, sillä ei-täysiä kerroksia ei ole lainkaan. Riviltä 27 eteenpäin koodin logiikka on sama kuin aiemmin: lasketaan säteiden päätepisteiden siirrot detektorin tasossa ja tehdään koordinaatistomuunnos kolmiulotteisen kuva-alueen koordinaatistoon.

\subsection{OMEGA-integraatio}
Koska käyttäjän on suunniteltu muokkaavan ainoastaan MATLAB-tiedostoja ja erityisesti pääohjelmaa, C++-funktioiden lisääminen valmiiseen ohjelmistoon vaati dataa käsittelevien funktioiden muokkaamista.

Oleellisin muutos oli sinogrammin datapisteitä vastaavien säteiden määritys. Siddonin algoritmin toteutus tarvitsee kaksi pistettä säteen virittämältä suoralta kolmiulotteisessa avaruudessa, mutta sinogrammin muodossa olevasta datasta nähdään suoraan ainoastaan detektoripaneelin orientaatio ja etäisyys kuva-alueen keskipisteestä. Näiden ja detektoripaneelin ominaisuuksien avulla laskettiin jokaiselle havainnolle detektoripaneelia kohtisuorassa olevalta suoralta kaksi pistettä, jotta dataa voidaan käyttää sellaisenaan ilman muita muutoksia koodiin. Toinen merkittävä muutos oli pääohjelmaan lisättyjen parametrien tarkistus ja niiden siirtäminen C++-funktiolle.

Varsinaiset C++:lla toteutetut kollimaattorin mallit olivat suoraviivaisia lisätä ohjelmistoon. Ohjelmistossa oli valmiina loogiset muuttujat \texttt{CT} ja \texttt{PET}, joilla voidaan määrittää kullakin kuvantamismenetelmällä ajettavat koodin osiot. Vastaavasti ohjelmistoon lisättiin muuttuja \texttt{SPECT}. Liitteissä esitetyt funktiot lisättiin lähdekoodiin sellaisenaan ja niitä kutsuttiin \texttt{SPECT}-muuttujan ehtolauseessa ennen säteiden ja vokseleiden leikkausten laskemista. Koska tässä työssä toteutetut funktiot \texttt{computeSpectHexShifts} ja \texttt{computeSpectSquareShifts} palauttavat joukon pisteitä, säteiden ja vokseleiden leikkaukset lasketaan jokaiselle parille pisteitä erikseen ja tulokset keskiarvoistetaan.

OMEGA avoimen lähdekoodin ohjelmistona on saatavissa GitHubista\footnote{\url{https://github.com/villekf/OMEGA}}. SPECT-rekonstruktio on tarkoitus sisällyttää versioon 2.0, jonka julkaisu ajoittuu heinäkuulle 2024.